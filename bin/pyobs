#!/usr/bin/env python3
import matplotlib
import argparse
import os

from pyobs.application import Application

matplotlib.use('Agg')


def start_daemon(pid_file=None, *args, **kwargs):
    import daemon
    from daemon import pidfile

    # get run directory
    run_dir = os.path.dirname(pid_file)

    # This launches the daemon in its context
    with daemon.DaemonContext(
            working_directory=run_dir,
            umask=0o002,
            pidfile=pidfile.TimeoutPIDLockFile(pid_file)) as context:
        run(*args, **kwargs)


def run(config=None, log_file: str = None, log_level: str = 'info', log_rotate: bool = False, gui: bool = False,
        username: str = None, password: str = None, server: str = None, comm: str = None, *args, **kwargs):
    # create app
    app = Application(log_file, log_level, log_rotate)

    # run it
    app.run(config, username, password, server, comm)


def main():
    # argparse
    parser = argparse.ArgumentParser()
    parser.add_argument('config', type=str, help='Configuration file', nargs='?')

    # logging
    parser.add_argument('--log-level', type=str, choices=['critical', 'error', 'warning', 'info', 'debug'],
                        default='info')
    parser.add_argument('-l', '--log-file', type=str, help='file to write log into')
    parser.add_argument('--log-rotate', action='store_true', help='rotate logs automatically')

    # write pid file as daemon
    parser.add_argument('-p', '--pid-file', type=str)

    # show gui
    parser.add_argument('--gui', action='store_true', help='run in a GUI instead of a terminal')

    # comm
    parser.add_argument('--username', type=str, help='Username for connecting to server')
    parser.add_argument('--password', type=str, help='Password for connecting to server')
    parser.add_argument('--server', type=str, help='server:port for server to connect to')
    parser.add_argument('--comm', type=str, choices=['xmpp'], default='xmpp')

    # parse args
    args = parser.parse_args()

    # --gui and --pid-file don't work together
    if args.gui and args.pid_file:
        print('--gui and --pid-file cannot be used together.')
        return

    # get full path of config
    if args.config:
        args.config = os.path.abspath(args.config)

    # run it
    if args.pid_file:
        start_daemon(**vars(args))
    else:
        run(**vars(args))


if __name__ == '__main__':
    main()
